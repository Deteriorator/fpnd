==================================
 DNS Privacy Evaluation and Setup
==================================

Your overall online privacy "profile" is highly dependent on where your
DNS requests go.  Typically your initial DNS server address is provided
by your local router (or other DHCP server) which is a private IP address,
however, the router simply forwards the requests to another DNS server
configured in the router (typically your ISP provides these addresses).

The upshot of the above is your implicit trust in the humans who operate
those DNS servers, yet you have no idea how much data they log or where
it goes.  But it gets worse, since (legacy) DNS is plain-text and easily
intercepted by anyone on the network.  Sure you can try a commercial VPN
provider or configure your system to use one of Google's public DNS servers,
but plain-text DNS is a `well-documented`_ tracking and data collection
method.

.. _well-documented: README_DNS_privacy.rst


In order to rectify the problem you'll need to collect some system info:

* who owns/manages your network configs?
* who owns/manages your DNS config?

For Ubuntu bionic and focal, the answer is most likely one or more of
the following.

Net config:

* netplan
* cloud-init
* NetworkManager
* connman

DNS config:

* DHCP/netplan
* systemd-resolved
* NetworkManager
* connman

For Gentoo the answer is similar.

* netifrc/DHCP and openrc
* systemd-resolved
* NetworkManager
* connman


Ubuntu configuration
--------------------

Underneath everything you most likely have a netplan configuration file
(which is auto-generated by cloud-init on the "official" Ubuntu cloud
image and rootfs builds).

To find out, open a terminal and issue the following command::

  $ ls /etc/netplan/
  01-network-manager-all.yaml

The answer above is from the Ubuntu Mate rpi image.  Now ``cat`` the file::

  $ cat /etc/netplan/01-network-manager-all.yaml
  # Let NetworkManager manage all devices on this system
  network:
    version: 2
    renderer: NetworkManager

The above shows netplan does an immediate handoff to NetworkManager (which
will use either an external or internal DHCP client to handle the network
configuration).

Now we can look at the DNS configuration, mainly your ``/etc/resolv.conf``
file.  This can be ether a file or a symlink (if the latter, it will show
who is currently managing your DNS servers).

  $ ls -l /etc/resolv.conf
  lrwxrwxrwx 1 root root 32 Sep  4 21:54 /etc/resolv.conf -> /run/systemd/resolve/stub-resolv.conf

The above shows systemd-resolved is operating as your local DNS stub
resolver, where "stub resolver" means it is 1) local to your device only,
and 2) non-recursive.

To see what DNS servers are used for name resolution, issue the following
command in a terminal::

  $ systemd-resolve --status
  Global
            DNSSEC NTA: 10.in-addr.arpa
                        16.172.in-addr.arpa
                        168.192.in-addr.arpa
                        17.172.in-addr.arpa
                        18.172.in-addr.arpa
                        19.172.in-addr.arpa
                        20.172.in-addr.arpa
                        21.172.in-addr.arpa
                        22.172.in-addr.arpa
                        23.172.in-addr.arpa
                        24.172.in-addr.arpa
                        25.172.in-addr.arpa
                        26.172.in-addr.arpa
                        27.172.in-addr.arpa
                        28.172.in-addr.arpa
                        29.172.in-addr.arpa
                        30.172.in-addr.arpa
                        31.172.in-addr.arpa
                        corp
                        d.f.ip6.arpa
                        home
                        internal
                        intranet
                        lan
                        local
                        private
                        test

  Link 3 (enx84e714006ef7)
        Current Scopes: DNS
         LLMNR setting: yes
  MulticastDNS setting: no
        DNSSEC setting: no
      DNSSEC supported: no
           DNS Servers: 192.168.1.1
            DNS Domain: local.domain

  Link 2 (wlan0)
        Current Scopes: none
         LLMNR setting: yes
  MulticastDNS setting: no
        DNSSEC setting: no
      DNSSEC supported: no


What can we learn from the above output?

1. There are no global nameservers configured (if so, they would appear
   near the top)
2. The ethernet interface has one local nameserver
3. The wifi interface is currently not configured

Now we can look at the DNS server address(es) your system is actually
using by checking the contents of ``resolv.conf``.  In your terminal,
cat the file::

  $ cat /etc/resolv.conf
  # This file is managed by man:systemd-resolved(8). Do not edit.
  #
  (more comments)
  nameserver 127.0.0.53
  options edns0
  search local.domain

The above shows systemd is indeed "managing" the contents and will wipe
any changes if edited directly, so...

Since we'd like to use only the secure DNS servers *you* choose, we need
to tell systemd-resolved it no longer owns (or manages) ``resolv.conf``,
and the way we do that is by removing the symlink and creating a file
in its place.
